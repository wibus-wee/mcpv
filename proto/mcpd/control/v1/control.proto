syntax = "proto3";

package mcpd.control.v1;

option go_package = "mcpd/pkg/api/control/v1;controlv1";

service ControlPlaneService {
  rpc GetInfo(GetInfoRequest) returns (GetInfoResponse);
  rpc RegisterCaller(RegisterCallerRequest) returns (RegisterCallerResponse);
  rpc UnregisterCaller(UnregisterCallerRequest) returns (UnregisterCallerResponse);
  rpc ListTools(ListToolsRequest) returns (ListToolsResponse);
  rpc WatchTools(WatchToolsRequest) returns (stream ToolsSnapshot);
  rpc CallTool(CallToolRequest) returns (CallToolResponse);
  rpc CallToolTask(CallToolTaskRequest) returns (CallToolTaskResponse);
  rpc TasksGet(TasksGetRequest) returns (TasksGetResponse);
  rpc TasksList(TasksListRequest) returns (TasksListResponse);
  rpc TasksResult(TasksResultRequest) returns (TasksResultResponse);
  rpc TasksCancel(TasksCancelRequest) returns (TasksCancelResponse);
  rpc ListResources(ListResourcesRequest) returns (ListResourcesResponse);
  rpc WatchResources(WatchResourcesRequest) returns (stream ResourcesSnapshot);
  rpc ReadResource(ReadResourceRequest) returns (ReadResourceResponse);
  rpc ListPrompts(ListPromptsRequest) returns (ListPromptsResponse);
  rpc WatchPrompts(WatchPromptsRequest) returns (stream PromptsSnapshot);
  rpc GetPrompt(GetPromptRequest) returns (GetPromptResponse);
  rpc StreamLogs(StreamLogsRequest) returns (stream LogEntry);
  rpc WatchRuntimeStatus(WatchRuntimeStatusRequest) returns (stream RuntimeStatusSnapshot);
  rpc WatchServerInitStatus(WatchServerInitStatusRequest) returns (stream ServerInitStatusSnapshot);
  // SubAgent automatic tool discovery and execution
  rpc AutomaticMCP(AutomaticMCPRequest) returns (AutomaticMCPResponse);
  rpc AutomaticEval(AutomaticEvalRequest) returns (AutomaticEvalResponse);
  rpc IsSubAgentEnabled(IsSubAgentEnabledRequest) returns (IsSubAgentEnabledResponse);
}

message GetInfoRequest {}

message GetInfoResponse {
  string name = 1;
  string version = 2;
  string build = 3;
}

message RegisterCallerRequest {
  string caller = 1;
  int64 pid = 2;
  repeated string tags = 3;
  string server = 4;
}

message RegisterCallerResponse {
  string profile = 1;
}

message UnregisterCallerRequest {
  string caller = 1;
}

message UnregisterCallerResponse {}

message ListToolsRequest {
  string caller = 1;
}

message ListToolsResponse {
  ToolsSnapshot snapshot = 1;
}

message WatchToolsRequest {
  string caller = 1;
  string last_etag = 2;
}

message ToolsSnapshot {
  string etag = 1;
  repeated ToolDefinition tools = 2;
}

message ToolDefinition {
  string name = 1;
  // JSON encoding of mcp.Tool.
  bytes tool_json = 2;
}

message CallToolRequest {
  string caller = 1;
  string name = 2;
  // JSON encoding of tool arguments (mcp.CallToolParams.Arguments).
  bytes arguments_json = 3;
  string routing_key = 4;
}

message CallToolResponse {
  // JSON encoding of mcp.CallToolResult.
  bytes result_json = 1;
}

message CallToolTaskRequest {
  string caller = 1;
  string name = 2;
  // JSON encoding of tool arguments (mcp.CallToolParams.Arguments).
  bytes arguments_json = 3;
  string routing_key = 4;
  int64 ttl_ms = 5;
  int64 poll_interval_ms = 6;
}

message CallToolTaskResponse {
  Task task = 1;
}

message TasksGetRequest {
  string caller = 1;
  string task_id = 2;
}

message TasksGetResponse {
  Task task = 1;
}

message TasksListRequest {
  string caller = 1;
  string cursor = 2;
  int32 limit = 3;
}

message TasksListResponse {
  repeated Task tasks = 1;
  string next_cursor = 2;
}

message TasksResultRequest {
  string caller = 1;
  string task_id = 2;
}

message TasksResultResponse {
  TaskResult result = 1;
}

message TasksCancelRequest {
  string caller = 1;
  string task_id = 2;
}

message TasksCancelResponse {
  Task task = 1;
}

message Task {
  string task_id = 1;
  string status = 2;
  string status_message = 3;
  string created_at = 4;
  string last_updated_at = 5;
  int64 ttl_ms = 6;
  int64 poll_interval_ms = 7;
}

message TaskResult {
  string status = 1;
  bytes result_json = 2;
  int64 error_code = 3;
  string error_message = 4;
  bytes error_data_json = 5;
}

message ListResourcesRequest {
  string caller = 1;
  string cursor = 2;
}

message ListResourcesResponse {
  ResourcesSnapshot snapshot = 1;
  string next_cursor = 2;
}

message WatchResourcesRequest {
  string caller = 1;
  string last_etag = 2;
}

message ResourcesSnapshot {
  string etag = 1;
  repeated ResourceDefinition resources = 2;
}

message ResourceDefinition {
  string uri = 1;
  // JSON encoding of mcp.Resource.
  bytes resource_json = 2;
}

message ReadResourceRequest {
  string caller = 1;
  string uri = 2;
}

message ReadResourceResponse {
  // JSON encoding of mcp.ReadResourceResult.
  bytes result_json = 1;
}

message ListPromptsRequest {
  string caller = 1;
  string cursor = 2;
}

message ListPromptsResponse {
  PromptsSnapshot snapshot = 1;
  string next_cursor = 2;
}

message WatchPromptsRequest {
  string caller = 1;
  string last_etag = 2;
}

message PromptsSnapshot {
  string etag = 1;
  repeated PromptDefinition prompts = 2;
}

message PromptDefinition {
  string name = 1;
  // JSON encoding of mcp.Prompt.
  bytes prompt_json = 2;
}

message GetPromptRequest {
  string caller = 1;
  string name = 2;
  // JSON encoding of mcp.GetPromptParams.Arguments.
  bytes arguments_json = 3;
}

message GetPromptResponse {
  // JSON encoding of mcp.GetPromptResult.
  bytes result_json = 1;
}

message StreamLogsRequest {
  string caller = 1;
  LogLevel min_level = 2;
}

message LogEntry {
  string logger = 1;
  LogLevel level = 2;
  int64 timestamp_unix_nano = 3;
  // JSON encoding of mcp.LoggingMessageParams.Data.
  bytes data_json = 4;
}

enum LogLevel {
  LOG_LEVEL_UNSPECIFIED = 0;
  LOG_LEVEL_DEBUG = 1;
  LOG_LEVEL_INFO = 2;
  LOG_LEVEL_NOTICE = 3;
  LOG_LEVEL_WARNING = 4;
  LOG_LEVEL_ERROR = 5;
  LOG_LEVEL_CRITICAL = 6;
  LOG_LEVEL_ALERT = 7;
  LOG_LEVEL_EMERGENCY = 8;
}

// =============================================================================
// Runtime Status Watch
// =============================================================================

message WatchRuntimeStatusRequest {
  string caller = 1;
  string last_etag = 2;
}

message RuntimeStatusSnapshot {
  string etag = 1;
  repeated ServerRuntimeStatus statuses = 2;
  int64 generated_at_unix_nano = 3;
}

message ServerRuntimeStatus {
  string spec_key = 1;
  string server_name = 2;
  repeated InstanceStatus instances = 3;
  PoolStats stats = 4;
  PoolMetrics metrics = 5;
}

message InstanceStatus {
  string id = 1;
  string state = 2;
  int32 busy_count = 3;
  int64 last_active_unix_nano = 4;
  int64 spawned_at_unix_nano = 5;
  int64 handshaked_at_unix_nano = 6;
  int64 last_heartbeat_at_unix_nano = 7;
}

message PoolStats {
  int32 total = 1;
  int32 ready = 2;
  int32 busy = 3;
  int32 starting = 4;
  int32 draining = 5;
  int32 failed = 6;
  int32 initializing = 7;
  int32 handshaking = 8;
}

message PoolMetrics {
  int32 start_count = 1;
  int32 stop_count = 2;
  int64 total_calls = 3;
  int64 total_errors = 4;
  int64 total_duration_ms = 5;
  int64 last_call_at_unix_nano = 6;
}

// =============================================================================
// Server Init Status Watch
// =============================================================================

message WatchServerInitStatusRequest {
  string caller = 1;
}

message ServerInitStatusSnapshot {
  repeated ServerInitStatus statuses = 1;
  int64 generated_at_unix_nano = 2;
}

message ServerInitStatus {
  string spec_key = 1;
  string server_name = 2;
  int32 min_ready = 3;
  int32 ready = 4;
  int32 failed = 5;
  string state = 6;
  string last_error = 7;
  int64 updated_at_unix_nano = 8;
}

// =============================================================================
// SubAgent Automatic MCP
// =============================================================================

message AutomaticMCPRequest {
  string caller = 1;
  string query = 2;
  string session_id = 3;
  bool force_refresh = 4;
}

message AutomaticMCPResponse {
  string etag = 1;
  repeated bytes tools_json = 2;
  int32 total_available = 3;
  int32 filtered = 4;
}

message AutomaticEvalRequest {
  string caller = 1;
  string tool_name = 2;
  bytes arguments_json = 3;
  string routing_key = 4;
}

message AutomaticEvalResponse {
  bytes result_json = 1;
}

message IsSubAgentEnabledRequest {
  string caller = 1;
}

message IsSubAgentEnabledResponse {
  bool enabled = 1;
}
